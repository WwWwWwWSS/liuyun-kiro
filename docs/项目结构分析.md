# Liuyun-Kiro 项目结构分析文档

## 一、项目概述

基于 Electron 38 + React 19 + TypeScript 5 的 Kiro IDE 多账号管理工具。

---

## 二、目录结构

```
liuyun-kiro/
├── src/
│   ├── main/                    # Electron 主进程
│   │   ├── index.ts             # 主进程入口（IPC处理、窗口管理、API调用）
│   │   └── machineId.ts         # 机器码管理模块
│   ├── preload/                 # 预加载脚本
│   │   └── index.ts             # contextBridge 暴露 API
│   └── renderer/                # React 渲染进程
│       └── src/
│           ├── App.tsx          # 主应用组件
│           ├── components/      # UI 组件
│           ├── store/           # Zustand 状态管理
│           ├── services/        # API 服务
│           ├── types/           # TypeScript 类型定义
│           ├── lib/             # 工具函数
│           ├── assets/          # 静态资源
│           └── styles/          # 样式文件
├── resources/                   # 应用图标等资源
└── build/                       # 构建配置
```

---

## 三、页面结构（当前）

### 3.1 侧边栏导航（6个页面）

| 页面 | 组件 | 功能描述 |
|------|------|----------|
| 主页 | `HomePage.tsx` | 账号统计、当前账号详情、额度统计、快速提示 |
| 账户管理 | `AccountManager.tsx` | 账号列表、添加/编辑/删除、批量操作、导入导出 |
| 机器码 | `MachineIdPage.tsx` | 机器码查看/修改/备份/恢复、账户绑定 |
| Kiro 设置 | `KiroSettingsPage.tsx` | Kiro IDE 配置管理、MCP 服务器、Steering 文件 |
| 设置 | `SettingsPage.tsx` | 主题、隐私、代理、自动刷新、自动换号等 |
| 关于 | `AboutPage.tsx` | 版本信息、更新检测、功能列表 |

### 3.2 侧边栏组件

- `Sidebar.tsx`: 可折叠侧边栏，包含 Logo 和导航菜单

---

## 四、核心功能模块

### 4.1 账号管理

**组件列表**:
- `AccountManager.tsx` - 账号管理主页面
- `AccountGrid.tsx` - 账号网格/列表展示
- `AccountCard.tsx` - 单个账号卡片
- `AccountToolbar.tsx` - 工具栏（添加、导入、导出、筛选）
- `AccountFilter.tsx` - 筛选面板
- `AddAccountDialog.tsx` - 添加账号对话框
- `EditAccountDialog.tsx` - 编辑账号对话框
- `AccountDetailDialog.tsx` - 账号详情对话框
- `GroupManageDialog.tsx` - 分组管理对话框
- `TagManageDialog.tsx` - 标签管理对话框
- `ExportDialog.tsx` - 导出对话框

**功能**:
- 添加账号（SSO Token、手动登录 Builder ID、Social Auth）
- 编辑/删除账号
- 切换当前使用账号
- 批量选择、批量删除
- 分组管理（一个账号一个分组）
- 标签管理（一个账号多个标签）
- 筛选（按订阅类型、状态、IDP、分组、标签、用量）
- 排序（按邮箱、用量、创建时间等）
- 导入导出（JSON、CSV、TXT）

### 4.2 Token 管理

- 自动刷新：Token 过期前 5 分钟自动刷新
- 支持 IdC (Builder ID) 和 Social (GitHub/Google) 两种刷新方式
- 批量刷新：后台并发刷新，不阻塞 UI
- 状态检查：获取账号用量、订阅信息

### 4.3 机器码管理

- 获取/修改当前机器码
- 备份/恢复原始机器码
- 切号时自动更换机器码
- 账户绑定机器码
- 机器码历史记录

### 4.4 自动换号

- 余额低于阈值时自动切换账号
- 可配置检查间隔

### 4.5 个性化设置

- 21 种主题颜色（按色系分组）
- 深色/浅色模式
- 隐私模式（隐藏敏感信息）

### 4.6 代理设置

- 支持 HTTP/HTTPS/SOCKS5 代理

### 4.7 更新检测

- GitHub API 检查最新版本
- 显示更新内容和下载链接

---

## 五、状态管理（Zustand Store）

### 5.1 accounts.ts - 主 Store

**状态字段**:
```typescript
// 数据
accounts: Map<string, Account>      // 账号列表
groups: Map<string, AccountGroup>   // 分组列表
tags: Map<string, AccountTag>       // 标签列表
activeAccountId: string | null      // 当前激活账号

// 筛选和排序
filter: AccountFilter
sort: AccountSort
selectedIds: Set<string>            // 选中的账号

// 设置
autoRefreshEnabled: boolean         // 自动刷新
autoRefreshInterval: number         // 刷新间隔（分钟）
autoRefreshConcurrency: number      // 刷新并发数
privacyMode: boolean                // 隐私模式
proxyEnabled: boolean               // 代理开关
proxyUrl: string                    // 代理地址
autoSwitchEnabled: boolean          // 自动换号
autoSwitchThreshold: number         // 换号阈值
autoSwitchInterval: number          // 换号检查间隔
theme: string                       // 主题
darkMode: boolean                   // 深色模式

// 机器码
machineIdConfig: {...}              // 机器码配置
currentMachineId: string            // 当前机器码
originalMachineId: string | null    // 原始机器码备份
accountMachineIds: Record<string, string>  // 账户绑定机器码
machineIdHistory: Array<{...}>      // 机器码历史
```

---

## 六、IPC API（主进程 ↔ 渲染进程）

### 6.1 账号管理
- `load-accounts` - 加载账号数据
- `save-accounts` - 保存账号数据
- `refresh-account-token` - 刷新单个账号 Token
- `check-account-status` - 检查账号状态
- `background-batch-refresh` - 后台批量刷新
- `background-batch-check` - 后台批量检查
- `switch-account` - 切换账号（写入本地 SSO 缓存）
- `verify-account-credentials` - 验证凭证

### 6.2 登录相关
- `import-from-sso-token` - 从 SSO Token 导入
- `start-builder-id-login` - 启动 Builder ID 登录
- `poll-builder-id-auth` - 轮询授权状态
- `start-social-login` - 启动 Social Auth 登录
- `exchange-social-token` - 交换 Social Token
- `load-kiro-credentials` - 从 Kiro 本地配置导入
- `get-local-active-account` - 获取本地活跃账号

### 6.3 机器码管理
- `machine-id:get-current` - 获取当前机器码
- `machine-id:set` - 设置机器码
- `machine-id:generate-random` - 生成随机机器码
- `machine-id:check-admin` - 检查管理员权限
- `machine-id:backup-to-file` - 备份到文件
- `machine-id:restore-from-file` - 从文件恢复

### 6.4 文件操作
- `export-to-file` - 导出到文件
- `import-from-file` - 从文件导入

### 6.5 代理设置
- `set-proxy` - 设置代理

### 6.6 更新检测
- `check-for-updates` - 检查更新（electron-updater）
- `check-for-updates-manual` - 手动检查（GitHub API）
- `download-update` - 下载更新
- `install-update` - 安装更新

### 6.7 Kiro 设置
- `get-kiro-settings` - 获取 Kiro 设置
- `save-kiro-settings` - 保存 Kiro 设置
- `open-kiro-mcp-config` - 打开 MCP 配置
- `open-kiro-steering-folder` - 打开 Steering 目录
- `save-mcp-server` / `delete-mcp-server` - MCP 服务器管理

### 6.8 其他
- `open-external` - 打开外部链接
- `get-app-version` - 获取应用版本

---

## 七、类型定义

### 7.1 Account（账号）
```typescript
interface Account {
  id: string
  email: string
  nickname?: string
  idp: 'Google' | 'Github' | 'BuilderId' | 'AWSIdC' | 'Internal'
  userId?: string
  credentials: AccountCredentials
  subscription: AccountSubscription
  usage: AccountUsage
  groupId?: string
  tags: string[]
  status: 'active' | 'expired' | 'error' | 'refreshing' | 'unknown'
  isActive: boolean
  createdAt: number
  lastUsedAt: number
}
```

### 7.2 AccountCredentials（凭证）
```typescript
interface AccountCredentials {
  accessToken: string
  csrfToken: string
  refreshToken?: string
  clientId?: string
  clientSecret?: string
  region?: string
  expiresAt: number
  authMethod?: 'IdC' | 'social'
  provider?: 'BuilderId' | 'Github' | 'Google'
}
```

---

## 八、UI 组件库

基础组件（`components/ui/`）:
- `Button` - 按钮
- `Card` - 卡片
- `Badge` - 徽章
- `Alert` - 警告
- `Progress` - 进度条
- `Select` - 下拉选择
- `Toggle` - 开关

---

## 九、重构建议（简化为单页面）

### 9.1 保留功能
- 账号列表展示（卡片/网格）
- 添加/编辑/删除账号
- 切换账号
- 批量操作
- 导入导出
- 自动刷新
- 隐私模式

### 9.2 可删除/简化的功能
- ❌ 侧边栏导航 → 改为顶部工具栏
- ❌ 主页（HomePage）→ 合并到主界面
- ❌ 关于页面（AboutPage）→ 改为弹窗或移除
- ❌ Kiro 设置页面（KiroSettingsPage）→ 移除或改为弹窗
- ⚠️ 机器码页面 → 可保留为弹窗
- ⚠️ 设置页面 → 可保留为弹窗

### 9.3 可删除的 IPC API
- Kiro 设置相关（如果移除 KiroSettingsPage）
- GitHub 更新检测（如果移除 AboutPage）

### 9.4 新界面布局参考
```
┌─────────────────────────────────────────────────┐
│ [设置] [购物车] [开关]    标题    [分享][刷新][设置][登录] │  ← 顶部工具栏
├─────────────────────────────────────────────────┤
│                                                 │
│                   账号列表                       │  ← 主内容区
│                 （卡片/网格）                    │
│                                                 │
├─────────────────────────────────────────────────┤
│ [+] 共N个    < 1/N >    10条/页 ~    [网格][列表] │  ← 底部状态栏
└─────────────────────────────────────────────────┘
```

---

## 十、依赖清单

### 生产依赖
- `electron` - 桌面应用框架
- `react` / `react-dom` - UI 框架
- `zustand` - 状态管理
- `tailwindcss` - CSS 框架
- `lucide-react` - 图标库
- `cbor-x` - CBOR 编解码（Kiro API）
- `electron-store` - 本地存储
- `uuid` - UUID 生成

### 开发依赖
- `electron-vite` - 构建工具
- `electron-builder` - 打包工具
- `typescript` - 类型检查
- `eslint` / `prettier` - 代码规范
